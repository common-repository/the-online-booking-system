<?php include("../../../../wp-config.php"); include_once("functions.php"); global $wpdb;  function listCalendarByRange($sd, $ed,$empid,$status)  {	  $ret = array();	  $ret['events'] = array();	  $ret["issort"] =true;	  $ret["start"] = php2JsTime($sd);	  $ret["end"] = php2JsTime($ed);	  $ret['error'] = null;	  try	  {		$flag = 0;			global $wpdb;			$table_name = $wpdb->prefix . "sm_bookings";			if($empid!="ALL")			{			$statuss = $_GET['status'];			switch($statuss) 			{				case "Approval Pending" :				//$sql = $wpdb->get_results				//(				//	$wpdb->prepare				//	(					//	  "SELECT id,StartTime,EndTime,service_id,color,emp_id,2 as blocked FROM ".$wpdb->prefix."sm_bookings "				//	)			//	);					$sql = $wpdb->get_results("SELECT id,StartTime,EndTime,service_id,color,emp_id,2 as blocked FROM ". $table_name ." WHERE StartTime between '".php2MySqlTime($sd)."' and '". php2MySqlTime($ed)."' and emp_id = '" . $empid. "' and status = 'Approval Pending' order by StartTime ASC");								break;								case "Approved" :				$sql = $wpdb->get_results("SELECT id,StartTime,EndTime,service_id,color,emp_id,2 as blocked FROM ". $table_name ." WHERE StartTime between '".php2MySqlTime($sd)."' and '". php2MySqlTime($ed)."' and emp_id = '" . $empid. "' and status = 'Approved' order by StartTime ASC");				break;								case "Disapproved" :				$sql = $wpdb->get_results("SELECT id,StartTime,EndTime,service_id,color,emp_id,2 as blocked FROM ". $table_name ." WHERE StartTime between '".php2MySqlTime($sd)."' and '". php2MySqlTime($ed)."' and emp_id = '" . $empid. "' and status = 'Disapproved' order by StartTime ASC");				break;								case "Cancelled" :				$sql = $wpdb->get_results("SELECT id,StartTime,EndTime,service_id,color,emp_id,2 as blocked FROM ". $table_name ." WHERE StartTime between '".php2MySqlTime($sd)."' and '". php2MySqlTime($ed)."' and emp_id = '" . $empid. "'  and status = 'Cancelled' order by StartTime ASC");				break;								case "ALL" :				$block_table = $wpdb->prefix . "sm_block_time";				$employee_table = $wpdb->prefix . "sm_employees";				$sql = $wpdb->get_results("(SELECT id,StartTime,EndTime,service_id,color,emp_id,2 as blocked FROM ". $table_name ." WHERE StartTime between '".php2MySqlTime($sd)."' and '". php2MySqlTime($ed)."' and emp_id = '" . $empid. "') union all"  . "(SELECT " . $block_table . ".id,timeof as StartTime,endtime as EndTime,1 as service_id," . $employee_table . ".emp_color as color,emp_id,blocked FROM " . $block_table . " join " . $employee_table . " on " . $block_table . ".emp_id = " . $employee_table . ".id where " . $block_table . ".emp_id = " . $empid . ") order by StartTime ASC");				break;								case "timeoff" :				$table_name = $wpdb->prefix . "sm_block_time";				$employee_table = $wpdb->prefix . "sm_employees";				$sql = $wpdb->get_results("SELECT " . $table_name . ".id,timeof,endtime,1," . $employee_table . ".emp_color as color,emp_id,blocked FROM ". $table_name ." join " . $employee_table . " on ". $table_name .".emp_id = " . $employee_table . ".id  where emp_id = " . "'" . $empid. "'" ." order by timeof ASC");				$flag = 1;				break;			}			}			else			{			switch ($_GET['status']) 			{				case "Approval Pending" :				$sql = $wpdb->get_results("SELECT id,StartTime,EndTime,service_id,color,emp_id,2 as blocked FROM ". $table_name ." WHERE StartTime between '".php2MySqlTime($sd)."' and '". php2MySqlTime($ed)."' and status = 'Approval Pending' order by StartTime ASC");				break;								case "Approved" :				$sql = $wpdb->get_results("SELECT id,StartTime,EndTime,service_id,color,emp_id,2 as blocked FROM ". $table_name ." WHERE StartTime between '".php2MySqlTime($sd)."' and '". php2MySqlTime($ed)."' and status = 'Approved' order by StartTime ASC");				break;								case "Disapproved" :				$sql = $wpdb->get_results("SELECT id,StartTime,EndTime,service_id,color,emp_id,2 as blocked FROM ". $table_name ." WHERE StartTime between '".php2MySqlTime($sd)."' and '". php2MySqlTime($ed)."' and status = 'Disapproved' order by StartTime ASC");				break;								case "Cancelled" :				$sql = $wpdb->get_results("SELECT id,StartTime,EndTime,service_id,color,emp_id,2 as blocked FROM ". $table_name ." WHERE StartTime between '".php2MySqlTime($sd)."' and '". php2MySqlTime($ed)."' and status = 'Cancelled' order by StartTime ASC");				break;								case "ALL" :				$block_table = $wpdb->prefix . "sm_block_time";				$employee_table = $wpdb->prefix . "sm_employees";				$sql = $wpdb->get_results("(SELECT id,StartTime,EndTime,service_id,color,emp_id,2 as blocked FROM ". $table_name ." WHERE StartTime between '".php2MySqlTime($sd)."' and '". php2MySqlTime($ed)."') union all"  . "(SELECT " . $block_table . ".id,timeof as StartTime,endtime as EndTime,1 as service_id," . $employee_table . ".emp_color  as color,emp_id,blocked FROM  " . $block_table . " join " . $employee_table . " on " . $block_table . ".emp_id = " . $employee_table . ".id) order by StartTime ASC");				break;								case "timeoff" :				$table_name = $wpdb->prefix . "sm_block_time";				$employee_table = $wpdb->prefix . "sm_employees";				$sql = $wpdb->get_results("SELECT " . $table_name . ".id,timeof,endtime,1," . $employee_table . ".emp_color as color,emp_id,blocked FROM ". $table_name ." join " . $employee_table . " on ". $table_name .".emp_id = " . $employee_table . ".id order by timeof ASC");				$flag = 1;				break;							}			}		if($flag == 0)		{					 for($i=0;$i<count($sql);$i++)			 {			 if($sql[$i]->blocked == 2)			 {				$seridd = $wpdb->get_var('SELECT name FROM ' . $wpdb->prefix . sm_services . ' WHERE id = ' . '"' . $sql[$i]->service_id . '"');				$emp_id = $sql[$i]->emp_id;			 }			 else			 {				 if($sql[$i]->blocked == 1)				{					$seridd = "Time Off";				}				else				{					$seridd = "Day Off";				}				$emp_id = 0;							 }					 					 $ret['events'][] = array(					 $sql[$i]->id,					 $seridd,					 php2JsTime(mySql2PhpTime($sql[$i]->StartTime)),					 php2JsTime(mySql2PhpTime($sql[$i]->EndTime)),					 0,					 0, 					 0,					 $sql[$i]->color,					 1,					 1,					 $emp_id,				 					);						}	   }	   else	   {	   for($i=0;$i<count($sql);$i++)	 	 {		 				 if($sql[$i]->blocked == 1)			 {			 $title = "Time Off";			 }			 else			 {			 $title = "Day Off";			 }	 	 $ret['events'][] = array(         $sql[$i]->id,         $title,		 php2JsTime(mySql2PhpTime($sql[$i]->timeof)),         php2JsTime(mySql2PhpTime($sql[$i]->endtime)),         0,         0,          0,          $sql[$i]->color,         1,         1,		 0,             );       }	   }	   $ret['IsSuccess'] = true;       $ret['Msg'] = 'Successfully';	 }	catch(Exception $e){     $ret['error'] = $e->getMessage();  }  return $ret;}function listCalendar($day, $type,$empid,$status){  $phpTime = js2PhpTime($day);    switch($type)    {      case "month":	      $st = mktime(0, 0, 0, date("m", $phpTime), 1, date("Y", $phpTime));	      $et = mktime(0, 0, -1, date("m", $phpTime)+1, 1, date("Y", $phpTime));     	 break;      case "week":	      $monday  =  date("d", $phpTime) - date('N', $phpTime) + 1;	      $st = mktime(0,0,0,date("m", $phpTime), $monday, date("Y", $phpTime));	      $et = mktime(0,0,-1,date("m", $phpTime), $monday+7, date("Y", $phpTime));     	 break;    case "day":    	  $st = mktime(0, 0, 0, date("m", $phpTime), date("d", $phpTime), date("Y", $phpTime));     	 $et = mktime(0, 0, -1, date("m", $phpTime), date("d", $phpTime)+1, date("Y", $phpTime));     	 break;  }    return listCalendarByRange($st, $et,$empid,$status);}function updateCalendar($id, $st, $et,$hr,$mn,$mnth,$dyy,$year,$empid,$status)  {	$ret = array();    try	{    global $wpdb;    $cout =  $wpdb->get_var('SELECT count(service_id) FROM '. $wpdb->prefix . 'sm_bookings WHERE (StartTime between '.'"'.php2MySqlTime(js2PhpTime($st)).'"'.'  AND '.'"' . php2MySqlTime(js2PhpTime($et)) . '" or endtime between '.'"'.php2MySqlTime(js2PhpTime($st)).'"'.'  AND '.'"' . php2MySqlTime(js2PhpTime($et)) . '"'. ') AND status !=' . '"' . "Disapproved".'"');	$countbok =  $wpdb->get_var('SELECT count(service_id) FROM '. $wpdb->prefix . 'sm_bookings WHERE (StartTime between '.'"'.php2MySqlTime(js2PhpTime($st)).'"'.'  AND '.'"' . php2MySqlTime(js2PhpTime($et)) . '" or endtime between '.'"'.php2MySqlTime(js2PhpTime($st)).'"'.'  AND '.'"' . php2MySqlTime(js2PhpTime($et)) . '"'. ') AND id =' . '"' . $id. '"'.' AND status !=' . '"' . "Disapproved".'"');	$counemp =  $wpdb->get_var('SELECT count(emp_id) FROM '. $wpdb->prefix . 'sm_bookings WHERE (StartTime between '.'"'.php2MySqlTime(js2PhpTime($st)).'"'.'  AND '.'"' . php2MySqlTime(js2PhpTime($et)) . '" or endtime between '.'"'.php2MySqlTime(js2PhpTime($st)).'"'.'  AND '.'"' . php2MySqlTime(js2PhpTime($et)) . '"'. ') AND emp_id =' . '"' . $empid. '"'.' AND status !=' . '"' . "Disapproved".'"');	$counempidd =  $wpdb->get_var('SELECT count(emp_id) FROM '. $wpdb->prefix . 'sm_bookings WHERE (StartTime between '.'"'.php2MySqlTime(js2PhpTime($st)).'"'.'  AND '.'"' . php2MySqlTime(js2PhpTime($et)) . '" or endtime between '.'"'.php2MySqlTime(js2PhpTime($st)).'"'.'  AND '.'"' . php2MySqlTime(js2PhpTime($et)) . '"'. ') AND emp_id =' . '"' . $empid. '"'.' AND status !=' . '"' . "Disapproved".'"'.' AND id =' . '"' . $id. '"');	$costet =  $wpdb->get_var('SELECT count(id) FROM '. $wpdb->prefix . 'sm_bookings WHERE StartTime = '.'"'.php2MySqlTime(js2PhpTime($et)).'"' . ' AND emp_id =' . '"' . $empid. '"'.' AND status !=' . '"' . "Disapproved".'"');	$costst =  $wpdb->get_var('SELECT count(id) FROM '. $wpdb->prefix . 'sm_bookings WHERE EndTime = '.'"'.php2MySqlTime(js2PhpTime($st)).'"' . ' AND emp_id =' . '"' . $empid. '"'.' AND status !=' . '"' . "Disapproved".'"');	if($cout==0)	{			$table_name = $wpdb->prefix . "sm_bookings";			$dat=$year."-".$mnth."-"."-".$dyy;			$qry = "UPDATE " . $table_name ."  SET starttime = ". '"' . php2MySqlTime(js2PhpTime($st)) . '"' . ", endtime = " . '"' . php2MySqlTime(js2PhpTime($et)) . '"' . ", minute = " . '"' . $mn . '"' . ", hour = " . '"' . $hr . '"' . ", month = " . '"' . $mnth . '"' . ", day = " . '"' . $dyy . '"' . ",Date = " . '"' . $dat . '"' . ", year = " . '"' . $year . '"' . " WHERE id = " . $id;			$wpdb->query($qry);			$ret['IsSuccess'] = true;			$ret['Msg'] = 'Successfully';     }	 else if($countbok==1 && $cout==1)	 {			$table_name = $wpdb->prefix . "sm_bookings";			$dat=$year."-".$mnth."-"."-".$dyy;			$qry = "UPDATE " . $table_name . "  SET starttime = ". '"' . php2MySqlTime(js2PhpTime($st)) . '"' . ", endtime = " . '"' . php2MySqlTime(js2PhpTime($et)) . '"' . ", minute = " . '"' . $mn . '"' . ", hour = " . '"' . $hr . '"' . ", month = " . '"' . $mnth . '"' . ", day = " . '"' . $dyy . '"' . ",Date = " . '"' . $dat . '"' . ", year = " . '"' . $year . '"' . " WHERE id = " . $id;			$wpdb->query($qry);			$ret['IsSuccess'] = true;			$ret['Msg'] = 'Successfully';	  }	  else if($counemp==0)	  {			$table_name = $wpdb->prefix . "sm_bookings";			$dat=$year."-".$mnth."-"."-".$dyy;			$qry = "UPDATE " . $table_name . "  SET starttime = ". '"' . php2MySqlTime(js2PhpTime($st)) . '"' . ", endtime = " . '"' . php2MySqlTime(js2PhpTime($et)) . '"' . ", minute = " . '"' . $mn . '"' . ", hour = " . '"' . $hr . '"' . ", month = " . '"' . $mnth . '"' . ", day = " . '"' . $dyy . '"' . ",Date = " . '"' . $dat . '"' . ", year = " . '"' . $year . '"' . " WHERE id = " . $id;			$wpdb->query($qry);			$ret['IsSuccess'] = true;			$ret['Msg'] = 'Successfully';	 }	 else if($counemp==1 && $counempidd==1)	 {			$table_name = $wpdb->prefix . "sm_bookings";			$dat=$year."-".$mnth."-"."-".$dyy;			$qry = "UPDATE " . $table_name . "  SET starttime = ". '"' . php2MySqlTime(js2PhpTime($st)) . '"' . ", endtime = " . '"' . php2MySqlTime(js2PhpTime($et)) . '"' . ", minute = " . '"' . $mn . '"' . ", hour = " . '"' . $hr . '"' . ", month = " . '"' . $mnth . '"' . ", day = " . '"' . $dyy . '"' . ",Date = " . '"' . $dat . '"' . ", year = " . '"' . $year . '"' . " WHERE id = " . $id;			$wpdb->query($qry);			$ret['IsSuccess'] = true;	 }	 else	 {	    $ret['IsSuccess'] = false;	 }	}	catch(Exception $e){     $ret['IsSuccess'] = false;     $ret['Msg'] = $e->getMessage();  }  return $ret; }    header('Content-type:text/javascript;charset=UTF-8');    $method = $_GET["method"];    switch ($method) 	{		    case "list":		    $ret = listCalendar($_POST["showdate"],$_POST["viewtype"],$_POST["emp_id"],$_POST["status"]);		    break;		    case "update":			$strttm=$_POST["CalendarStartTime"];			$str=explode(" ",$strttm);			$s=$str[1];			$strttime=explode(":",$s);			$dy=$str[0];			$strtdy=explode("/",$dy);		    $ret = updateCalendar($_POST["calendarId"],$_POST["CalendarStartTime"], $_POST["CalendarEndTime"],$strttime[0],$strttime[1],$strtdy[0],$strtdy[1],$strtdy[2],$_POST["empid"],$_POST["status"]);		    break;     }echo json_encode($ret); ?>